{
  "table": "reports",
  "description": "Website audit reports generated by Analysis Engine and stored in Supabase Storage",
  "columns": [
    {
      "name": "id",
      "type": "uuid",
      "primaryKey": true,
      "default": "gen_random_uuid()",
      "description": "Unique identifier for the report"
    },
    {
      "name": "lead_id",
      "type": "uuid",
      "description": "Reference to the analyzed lead"
    },
    {
      "name": "project_id",
      "type": "uuid",
      "description": "Reference to the project this report belongs to"
    },
    {
      "name": "report_type",
      "type": "text",
      "default": "'website_audit'",
      "required": true,
      "description": "Type of report (website_audit, competitive_analysis, etc.)"
    },
    {
      "name": "format",
      "type": "text",
      "default": "'markdown'",
      "required": true,
      "enum": ["markdown", "pdf", "html", "json"],
      "description": "Report format"
    },
    {
      "name": "storage_path",
      "type": "text",
      "required": true,
      "description": "Full path to file in Supabase Storage (e.g., reports/2025/01/lead-abc123.md)"
    },
    {
      "name": "storage_bucket",
      "type": "text",
      "default": "'reports'",
      "required": true,
      "description": "Supabase Storage bucket name"
    },
    {
      "name": "file_size_bytes",
      "type": "bigint",
      "description": "File size in bytes"
    },
    {
      "name": "company_name",
      "type": "text",
      "required": true,
      "description": "Company name from the analyzed lead"
    },
    {
      "name": "website_url",
      "type": "text",
      "required": true,
      "description": "Website URL that was analyzed"
    },
    {
      "name": "overall_score",
      "type": "integer",
      "description": "Overall score snapshot (0-100) for quick filtering"
    },
    {
      "name": "website_grade",
      "type": "text",
      "enum": ["A", "B", "C", "D", "F"],
      "description": "Letter grade snapshot for quick filtering"
    },
    {
      "name": "config",
      "type": "jsonb",
      "default": "'{}'::jsonb",
      "description": "Report generation configuration (sections included, theme, options)"
    },
    {
      "name": "status",
      "type": "text",
      "default": "'completed'",
      "required": true,
      "enum": ["generating", "completed", "failed"],
      "description": "Report generation status"
    },
    {
      "name": "error_message",
      "type": "text",
      "description": "Error message if report generation failed"
    },
    {
      "name": "download_count",
      "type": "integer",
      "default": "0",
      "description": "Number of times report has been downloaded"
    },
    {
      "name": "last_downloaded_at",
      "type": "timestamptz",
      "description": "When the report was last downloaded"
    },
    {
      "name": "generated_at",
      "type": "timestamptz",
      "default": "now()",
      "required": true,
      "description": "When the report was generated"
    },
    {
      "name": "created_at",
      "type": "timestamptz",
      "default": "now()",
      "description": "When this record was created"
    },
    {
      "name": "updated_at",
      "type": "timestamptz",
      "default": "now()",
      "description": "When this record was last updated"
    }
  ],
  "foreignKeys": [
    {
      "column": "lead_id",
      "references": "leads.id",
      "onDelete": "CASCADE"
    },
    {
      "column": "project_id",
      "references": "projects.id",
      "onDelete": "SET NULL"
    }
  ],
  "indexes": [
    {
      "name": "idx_reports_lead_id",
      "columns": ["lead_id"]
    },
    {
      "name": "idx_reports_project_id",
      "columns": ["project_id"]
    },
    {
      "name": "idx_reports_status",
      "columns": ["status"]
    },
    {
      "name": "idx_reports_format",
      "columns": ["format"]
    },
    {
      "name": "idx_reports_generated_at",
      "columns": ["generated_at"],
      "order": "DESC"
    },
    {
      "name": "idx_reports_company_name",
      "columns": ["company_name"]
    },
    {
      "name": "idx_reports_storage_path",
      "columns": ["storage_path"]
    }
  ],
  "constraints": [
    {
      "type": "check",
      "name": "chk_reports_format",
      "expression": "format IN ('markdown', 'pdf', 'html', 'json')"
    },
    {
      "type": "check",
      "name": "chk_reports_status",
      "expression": "status IN ('generating', 'completed', 'failed')"
    },
    {
      "type": "check",
      "name": "chk_reports_file_size_positive",
      "expression": "file_size_bytes IS NULL OR file_size_bytes >= 0"
    },
    {
      "type": "check",
      "name": "chk_reports_download_count_positive",
      "expression": "download_count >= 0"
    }
  ]
}