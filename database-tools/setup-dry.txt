
> database-tools@1.0.0 db:setup
> node cli.js setup --dry-run


ðŸ” Scanning for schema files...


ðŸ“„ Loading schemas...
âœ… database-tools/database/schemas/projects.json
âœ… database-tools/database/schemas/reports.json
âœ… prospecting-engine/database/schemas/project_prospects.json
âœ… prospecting-engine/database/schemas/prospects.json
âœ… analysis-engine/database/schemas/leads.json
âœ… analysis-engine/database/schemas/page_analyses.json
âœ… outreach-engine/database/schemas/composed_emails.json
âœ… pipeline-orchestrator/database/schemas/campaigns.json
âœ… pipeline-orchestrator/database/schemas/campaign_runs.json


ðŸ” Validating schemas...
âš ï¸ projects - Warnings
     âš ï¸  Column "name" is required but has no default value
âš ï¸ reports - Warnings
     âš ï¸  Column "storage_path" is required but has no default value
     âš ï¸  Column "company_name" is required but has no default value
     âš ï¸  Column "website_url" is required but has no default value
âš ï¸ project_prospects - Warnings
     âš ï¸  Column "project_id" is required but has no default value
     âš ï¸  Column "prospect_id" is required but has no default value
âš ï¸ prospects - Warnings
     âš ï¸  Column "company_name" is required but has no default value
     âš ï¸  Column "industry" is required but has no default value
âš ï¸ leads - Warnings
     âš ï¸  Column "company_name" is required but has no default value
     âš ï¸  Column "url" is required but has no default value
     âš ï¸  Column "website_grade" is required but has no default value
     âš ï¸  Column "overall_score" is required but has no default value
     âš ï¸  Column "design_score" is required but has no default value
     âš ï¸  Column "seo_score" is required but has no default value
     âš ï¸  Column "content_score" is required but has no default value
     âš ï¸  Column "social_score" is required but has no default value
âœ… page_analyses - Valid
âš ï¸ composed_emails - Warnings
     âš ï¸  Column "url" is required but has no default value
     âš ï¸  Column "company_name" is required but has no default value
     âš ï¸  Column "email_body" is required but has no default value
âš ï¸ campaigns - Warnings
     âš ï¸  Column "name" is required but has no default value
     âš ï¸  Column "config" is required but has no default value
âš ï¸ campaign_runs - Warnings
     âš ï¸  Column "campaign_id" is required but has no default value


ðŸ”§ Resolving dependencies...
   projects (no dependencies)
   prospects (no dependencies)
   leads (depends on: prospects, projects)
   reports (depends on: leads, projects)
   project_prospects (depends on: projects, prospects)
   page_analyses (depends on: leads)
   composed_emails (depends on: leads, projects)
   campaigns (no dependencies)
   campaign_runs (depends on: campaigns)


ðŸ—ï¸  Generating SQL...
â„¹ Generated 9 CREATE TABLE statements
â„¹ Generated 56 CREATE INDEX statements
â„¹ Generated 10 ALTER TABLE (foreign keys)
â„¹ Generated 42 ALTER TABLE (check constraints)
â„¹ Generated 1 ALTER TABLE (unique constraints)


ðŸ“„ Generated SQL (Dry Run):

-- Generated by database-tools
-- Date: 2025-10-22T00:34:25.058Z
-- DO NOT EDIT THIS FILE MANUALLY

-- CREATE TABLES
-- projects (database-tools)
CREATE TABLE IF NOT EXISTS projects (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  name text NOT NULL,
  client_name text,
  description text,
  status text DEFAULT 'active' CHECK (status IN ('active', 'paused', 'completed', 'archived')),
  budget numeric(10,2),
  total_spent numeric(10,2) DEFAULT '0',
  budget_alert_threshold numeric(10,2),
  start_date date,
  end_date date,
  created_at timestamptz DEFAULT now(),
  updated_at timestamptz DEFAULT now(),
  icp_brief jsonb,
  analysis_config jsonb,
  outreach_config jsonb,
  analysis_prompts jsonb,
  prospecting_prompts jsonb,
  prospecting_model_selections jsonb,
  analysis_model_selections jsonb
);

-- prospects (prospecting-engine)
CREATE TABLE IF NOT EXISTS prospects (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  company_name text NOT NULL,
  industry text NOT NULL,
  website text,
  website_status text DEFAULT 'active' CHECK (website_status IN ('active', 'timeout', 'ssl_error', 'not_found', 'no_website')),
  city text,
  state text,
  address text,
  contact_email text,
  contact_phone text,
  contact_name text,
  description text,
  services jsonb,
  google_place_id text UNIQUE,
  google_rating decimal,
  google_review_count integer,
  social_profiles jsonb,
  social_metadata jsonb,
  icp_match_score integer,
  is_relevant boolean DEFAULT true,
  icp_brief_snapshot jsonb,
  status text DEFAULT 'ready_for_analysis' CHECK (status IN ('ready_for_analysis', 'queued', 'analyzing', 'analyzed', 'error')),
  run_id text,
  source text DEFAULT 'prospecting-engine',
  discovery_cost decimal,
  discovery_time_ms integer,
  created_at timestamptz DEFAULT now(),
  updated_at timestamptz DEFAULT now()
);

-- leads (analysis-engine)
CREATE TABLE IF NOT EXISTS leads (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  prospect_id uuid,
  company_name text NOT NULL,
  industry text,
  url text NOT NULL UNIQUE,
  city text,
  state text,
  contact_email text,
  contact_phone text,
  contact_name text,
  website_grade text NOT NULL,
  overall_score decimal NOT NULL,
  design_score decimal NOT NULL,
  design_score_desktop integer,
  design_score_mobile integer,
  seo_score decimal NOT NULL,
  content_score decimal NOT NULL,
  social_score decimal NOT NULL,
  accessibility_score integer,
  design_issues jsonb DEFAULT '[]',
  design_issues_desktop jsonb DEFAULT '[]',
  design_issues_mobile jsonb DEFAULT '[]',
  mobile_critical_issues integer DEFAULT 0,
  desktop_critical_issues integer DEFAULT 0,
  seo_analysis_model text,
  content_analysis_model text,
  desktop_visual_model text,
  mobile_visual_model text,
  social_analysis_model text,
  accessibility_analysis_model text,
  seo_issues jsonb DEFAULT '[]',
  content_issues jsonb DEFAULT '[]',
  social_issues jsonb DEFAULT '[]',
  accessibility_issues jsonb DEFAULT '[]',
  accessibility_compliance jsonb DEFAULT '{}',
  quick_wins jsonb DEFAULT '[]',
  analysis_summary text,
  top_issue jsonb,
  one_liner text,
  call_to_action text,
  outreach_angle text,
  tech_stack text,
  page_load_time integer,
  is_mobile_friendly boolean DEFAULT false,
  has_https boolean DEFAULT false,
  screenshot_desktop_url text,
  screenshot_mobile_url text,
  social_profiles jsonb,
  social_platforms_present jsonb,
  social_metadata jsonb,
  has_blog boolean DEFAULT false,
  content_insights jsonb,
  page_title text,
  meta_description text,
  status text DEFAULT 'ready_for_outreach' CHECK (status IN ('ready_for_outreach', 'email_composed', 'contacted', 'replied', 'not_interested')),
  lead_priority integer,
  lead_priority_reasoning text,
  priority_tier text CHECK (priority_tier IN ('hot', 'warm', 'cold')),
  budget_likelihood text CHECK (budget_likelihood IN ('high', 'medium', 'low')),
  fit_score integer,
  quality_gap_score integer,
  budget_score integer,
  urgency_score integer,
  industry_fit_score integer,
  company_size_score integer,
  engagement_score integer,
  business_intelligence jsonb,
  crawl_metadata jsonb,
  project_id uuid,
  pages_discovered integer,
  pages_crawled integer,
  pages_analyzed integer,
  ai_page_selection jsonb,
  analyzed_at timestamptz DEFAULT now(),
  analysis_cost decimal,
  analysis_time integer,
  discovery_log jsonb,
  created_at timestamptz DEFAULT now(),
  updated_at timestamptz DEFAULT now()
);

-- reports (database-tools)
CREATE TABLE IF NOT EXISTS reports (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  lead_id uuid,
  project_id uuid,
  report_type text NOT NULL DEFAULT 'website_audit',
  format text NOT NULL DEFAULT 'markdown' CHECK (format IN ('markdown', 'pdf', 'html', 'json')),
  storage_path text NOT NULL,
  storage_bucket text NOT NULL DEFAULT 'reports',
  file_size_bytes bigint,
  company_name text NOT NULL,
  website_url text NOT NULL,
  overall_score integer,
  website_grade text CHECK (website_grade IN ('A', 'B', 'C', 'D', 'F')),
  config jsonb DEFAULT ''{}'::jsonb',
  status text NOT NULL DEFAULT 'completed' CHECK (status IN ('generating', 'completed', 'failed')),
  error_message text,
  download_count integer DEFAULT '0',
  last_downloaded_at timestamptz,
  generated_at timestamptz NOT NULL DEFAULT now(),
  created_at timestamptz DEFAULT now(),
  updated_at timestamptz DEFAULT now()
);

-- project_prospects (prospecting-engine)
CREATE TABLE IF NOT EXISTS project_prospects (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  project_id uuid NOT NULL,
  prospect_id uuid NOT NULL,
  run_id text,
  added_at timestamptz DEFAULT now(),
  notes text,
  custom_score integer,
  status text DEFAULT 'active' CHECK (status IN ('active', 'contacted', 'qualified', 'disqualified', 'archived')),
  discovery_query text,
  query_generation_model text,
  icp_brief_snapshot jsonb,
  prompts_snapshot jsonb,
  model_selections_snapshot jsonb,
  relevance_reasoning text,
  discovery_cost_usd decimal,
  discovery_time_ms integer
);

-- page_analyses (analysis-engine)
CREATE TABLE IF NOT EXISTS page_analyses (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  lead_id uuid,
  url text,
  full_url text,
  page_title text,
  page_type text,
  seo_analyzed boolean DEFAULT false,
  seo_score integer,
  seo_issues jsonb DEFAULT '[]',
  content_analyzed boolean DEFAULT false,
  content_score integer,
  content_issues jsonb DEFAULT '[]',
  visual_desktop_analyzed boolean DEFAULT false,
  visual_desktop_score integer,
  visual_desktop_issues jsonb DEFAULT '[]',
  visual_mobile_analyzed boolean DEFAULT false,
  visual_mobile_score integer,
  visual_mobile_issues jsonb DEFAULT '[]',
  social_analyzed boolean DEFAULT false,
  social_score integer,
  social_issues jsonb DEFAULT '[]',
  load_time integer,
  analysis_model text,
  created_at timestamp DEFAULT now(),
  updated_at timestamp DEFAULT now()
);

-- composed_emails (outreach-engine)
CREATE TABLE IF NOT EXISTS composed_emails (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  lead_id uuid,
  url text NOT NULL,
  company_name text NOT NULL,
  industry text,
  contact_email text,
  contact_name text,
  contact_title text,
  email_subject text,
  email_body text NOT NULL,
  email_strategy text,
  platform text DEFAULT 'email' CHECK (platform IN ('email', 'instagram', 'facebook', 'linkedin', 'twitter')),
  character_count integer,
  social_profile_url text,
  has_variants boolean DEFAULT false,
  subject_variants jsonb,
  body_variants jsonb,
  recommended_variant jsonb,
  variant_reasoning text,
  technical_reasoning text,
  business_summary text,
  verification_checklist jsonb,
  quality_score integer,
  validation_issues jsonb,
  status text DEFAULT 'ready' CHECK (status IN ('pending', 'ready', 'approved', 'rejected', 'sent', 'failed', 'bounced')),
  reviewed_at timestamptz,
  sent_at timestamptz,
  email_message_id text,
  notion_page_id text,
  synced_to_notion boolean DEFAULT false,
  notion_sync_at timestamptz,
  project_id uuid,
  campaign_id text,
  client_name text,
  source_app text DEFAULT 'outreach-engine',
  ai_model text,
  generation_cost decimal,
  generation_time_ms integer,
  usage_input_tokens integer,
  usage_output_tokens integer,
  created_at timestamptz DEFAULT now(),
  updated_at timestamptz DEFAULT now()
);

-- campaigns (pipeline-orchestrator)
CREATE TABLE IF NOT EXISTS campaigns (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  name text NOT NULL,
  description text,
  config jsonb NOT NULL,
  schedule_cron text,
  status text DEFAULT 'active' CHECK (status IN ('active', 'paused', 'completed', 'error')),
  last_run_at timestamptz,
  next_run_at timestamptz,
  total_runs integer DEFAULT 0,
  total_cost decimal(10,2) DEFAULT 0,
  project_id uuid,
  created_at timestamptz DEFAULT now(),
  updated_at timestamptz DEFAULT now()
);

-- campaign_runs (pipeline-orchestrator)
CREATE TABLE IF NOT EXISTS campaign_runs (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  campaign_id uuid NOT NULL,
  started_at timestamptz DEFAULT now(),
  completed_at timestamptz,
  status text DEFAULT 'running' CHECK (status IN ('running', 'completed', 'failed', 'aborted')),
  steps_completed integer DEFAULT 0,
  steps_failed integer DEFAULT 0,
  results jsonb,
  total_cost decimal(10,2) DEFAULT 0,
  errors jsonb,
  trigger_type text DEFAULT 'scheduled' CHECK (trigger_type IN ('scheduled', 'manual'))
);

-- CREATE INDEXES
-- Indexes for projects
CREATE INDEX IF NOT EXISTS idx_projects_status ON projects(status);
CREATE INDEX IF NOT EXISTS idx_projects_client_name ON projects(client_name);
CREATE INDEX IF NOT EXISTS idx_projects_created_at ON projects(created_at);

-- Indexes for prospects
CREATE INDEX IF NOT EXISTS idx_prospects_company_name ON prospects(company_name);
CREATE INDEX IF NOT EXISTS idx_prospects_industry ON prospects(industry);
CREATE INDEX IF NOT EXISTS idx_prospects_website ON prospects(website);
CREATE INDEX IF NOT EXISTS idx_prospects_city ON prospects(city);
CREATE INDEX IF NOT EXISTS idx_prospects_status ON prospects(status);
CREATE INDEX IF NOT EXISTS idx_prospects_run_id ON prospects(run_id);
CREATE INDEX IF NOT EXISTS idx_prospects_status_city ON prospects(status, city);
CREATE INDEX IF NOT EXISTS idx_prospects_industry_rating ON prospects(industry, google_rating);
CREATE INDEX IF NOT EXISTS idx_prospects_run_id ON prospects(run_id);

-- Indexes for leads
CREATE INDEX IF NOT EXISTS idx_leads_prospect_id ON leads(prospect_id);
CREATE INDEX IF NOT EXISTS idx_leads_website_grade ON leads(website_grade);
CREATE INDEX IF NOT EXISTS idx_leads_overall_score ON leads(overall_score);
CREATE INDEX IF NOT EXISTS idx_leads_status ON leads(status);
CREATE INDEX IF NOT EXISTS idx_leads_lead_priority ON leads(lead_priority);
CREATE INDEX IF NOT EXISTS idx_leads_priority_tier ON leads(priority_tier);
CREATE INDEX IF NOT EXISTS idx_leads_status_grade ON leads(status, website_grade);
CREATE INDEX IF NOT EXISTS idx_leads_industry_score ON leads(industry, overall_score);
CREATE INDEX IF NOT EXISTS idx_leads_analyzed_at ON leads(analyzed_at);
CREATE INDEX IF NOT EXISTS idx_leads_priority_tier_score ON leads(priority_tier, lead_priority);
CREATE INDEX IF NOT EXISTS idx_leads_priority_budget_status ON leads(priority_tier, budget_likelihood, status);

-- Indexes for reports
CREATE INDEX IF NOT EXISTS idx_reports_lead_id ON reports(lead_id);
CREATE INDEX IF NOT EXISTS idx_reports_project_id ON reports(project_id);
CREATE INDEX IF NOT EXISTS idx_reports_status ON reports(status);
CREATE INDEX IF NOT EXISTS idx_reports_format ON reports(format);
CREATE INDEX IF NOT EXISTS idx_reports_generated_at ON reports(generated_at);
CREATE INDEX IF NOT EXISTS idx_reports_company_name ON reports(company_name);
CREATE INDEX IF NOT EXISTS idx_reports_storage_path ON reports(storage_path);

-- Indexes for project_prospects
CREATE INDEX IF NOT EXISTS idx_project_prospects_project_id ON project_prospects(project_id);
CREATE INDEX IF NOT EXISTS idx_project_prospects_prospect_id ON project_prospects(prospect_id);
CREATE INDEX IF NOT EXISTS idx_project_prospects_run_id ON project_prospects(run_id);
CREATE INDEX IF NOT EXISTS idx_project_prospects_status ON project_prospects(status);
CREATE INDEX IF NOT EXISTS idx_project_prospects_project ON project_prospects(project_id, status);
CREATE INDEX IF NOT EXISTS idx_project_prospects_prospect ON project_prospects(prospect_id);

-- Indexes for page_analyses
CREATE INDEX IF NOT EXISTS idx_page_analyses_lead_id ON page_analyses(lead_id);
CREATE INDEX IF NOT EXISTS idx_page_analyses_url ON page_analyses(url);
CREATE INDEX IF NOT EXISTS idx_page_analyses_page_type ON page_analyses(page_type);

-- Indexes for composed_emails
CREATE INDEX IF NOT EXISTS idx_composed_emails_lead_id ON composed_emails(lead_id);
CREATE INDEX IF NOT EXISTS idx_composed_emails_url ON composed_emails(url);
CREATE INDEX IF NOT EXISTS idx_composed_emails_company_name ON composed_emails(company_name);
CREATE INDEX IF NOT EXISTS idx_composed_emails_industry ON composed_emails(industry);
CREATE INDEX IF NOT EXISTS idx_composed_emails_platform ON composed_emails(platform);
CREATE INDEX IF NOT EXISTS idx_composed_emails_status ON composed_emails(status);
CREATE INDEX IF NOT EXISTS idx_composed_emails_project_id ON composed_emails(project_id);
CREATE INDEX IF NOT EXISTS idx_composed_emails_status_created ON composed_emails(status, created_at);
CREATE INDEX IF NOT EXISTS idx_composed_emails_project_status ON composed_emails(project_id, status);
CREATE INDEX IF NOT EXISTS idx_composed_emails_company ON composed_emails(company_name);
CREATE INDEX IF NOT EXISTS idx_composed_emails_sent_at ON composed_emails(sent_at);

-- Indexes for campaigns
CREATE INDEX IF NOT EXISTS idx_campaigns_status ON campaigns(status);
CREATE INDEX IF NOT EXISTS idx_campaigns_next_run ON campaigns(next_run_at);
CREATE INDEX IF NOT EXISTS idx_campaigns_project_id ON campaigns(project_id);

-- Indexes for campaign_runs
CREATE INDEX IF NOT EXISTS idx_campaign_runs_campaign_id ON campaign_runs(campaign_id);
CREATE INDEX IF NOT EXISTS idx_campaign_runs_status ON campaign_runs(status);
CREATE INDEX IF NOT EXISTS idx_campaign_runs_started_at ON campaign_runs(started_at);

-- CREATE FOREIGN KEY CONSTRAINTS
-- Foreign keys for leads
ALTER TABLE leads
  ADD CONSTRAINT fk_leads_prospect_id
  FOREIGN KEY (prospect_id)
  REFERENCES prospects(id) ON DELETE SET NULL;
ALTER TABLE leads
  ADD CONSTRAINT fk_leads_project_id
  FOREIGN KEY (project_id)
  REFERENCES projects(id) ON DELETE CASCADE;

-- Foreign keys for reports
ALTER TABLE reports
  ADD CONSTRAINT fk_reports_lead_id
  FOREIGN KEY (lead_id)
  REFERENCES leads(id) ON DELETE CASCADE;
ALTER TABLE reports
  ADD CONSTRAINT fk_reports_project_id
  FOREIGN KEY (project_id)
  REFERENCES projects(id) ON DELETE SET NULL;

-- Foreign keys for project_prospects
ALTER TABLE project_prospects
  ADD CONSTRAINT fk_project_prospects_project_id
  FOREIGN KEY (project_id)
  REFERENCES projects(id) ON DELETE CASCADE;
ALTER TABLE project_prospects
  ADD CONSTRAINT fk_project_prospects_prospect_id
  FOREIGN KEY (prospect_id)
  REFERENCES prospects(id) ON DELETE CASCADE;

-- Foreign keys for page_analyses
ALTER TABLE page_analyses
  ADD CONSTRAINT fk_page_analyses_lead_id
  FOREIGN KEY (lead_id)
  REFERENCES leads(id) ON DELETE CASCADE;

-- Foreign keys for composed_emails
ALTER TABLE composed_emails
  ADD CONSTRAINT fk_composed_emails_lead_id
  FOREIGN KEY (lead_id)
  REFERENCES leads(id) ON DELETE SET NULL;
ALTER TABLE composed_emails
  ADD CONSTRAINT fk_composed_emails_project_id
  FOREIGN KEY (project_id)
  REFERENCES projects(id) ON DELETE CASCADE;

-- Foreign keys for campaign_runs
ALTER TABLE campaign_runs
  ADD CONSTRAINT fk_campaign_runs_campaign_id
  FOREIGN KEY (campaign_id)
  REFERENCES campaigns(id) ON DELETE CASCADE;

-- CREATE CHECK CONSTRAINTS
-- Check constraints for projects
ALTER TABLE projects
  ADD CONSTRAINT chk_projects_budget_positive
  CHECK (budget IS NULL OR budget >= 0);
ALTER TABLE projects
  ADD CONSTRAINT chk_projects_spent_positive
  CHECK (total_spent >= 0);
ALTER TABLE projects
  ADD CONSTRAINT chk_projects_date_order
  CHECK (end_date IS NULL OR start_date IS NULL OR end_date >= start_date);

-- Check constraints for prospects
ALTER TABLE prospects
  ADD CONSTRAINT chk_google_rating_range
  CHECK (google_rating IS NULL OR (google_rating >= 1.0 AND google_rating <= 5.0));
ALTER TABLE prospects
  ADD CONSTRAINT chk_icp_match_score_range
  CHECK (icp_match_score IS NULL OR (icp_match_score >= 0 AND icp_match_score <= 100));
ALTER TABLE prospects
  ADD CONSTRAINT chk_google_review_count_positive
  CHECK (google_review_count IS NULL OR google_review_count >= 0);
ALTER TABLE prospects
  ADD CONSTRAINT chk_discovery_cost_positive
  CHECK (discovery_cost IS NULL OR discovery_cost >= 0);
ALTER TABLE prospects
  ADD CONSTRAINT chk_discovery_time_positive
  CHECK (discovery_time_ms IS NULL OR discovery_time_ms >= 0);

-- Check constraints for leads
ALTER TABLE leads
  ADD CONSTRAINT chk_overall_score_range
  CHECK (overall_score >= 0 AND overall_score <= 100);
ALTER TABLE leads
  ADD CONSTRAINT chk_design_score_range
  CHECK (design_score >= 0 AND design_score <= 100);
ALTER TABLE leads
  ADD CONSTRAINT chk_design_score_desktop_range
  CHECK (design_score_desktop IS NULL OR (design_score_desktop >= 0 AND design_score_desktop <= 100));
ALTER TABLE leads
  ADD CONSTRAINT chk_design_score_mobile_range
  CHECK (design_score_mobile IS NULL OR (design_score_mobile >= 0 AND design_score_mobile <= 100));
ALTER TABLE leads
  ADD CONSTRAINT chk_mobile_critical_issues_positive
  CHECK (mobile_critical_issues >= 0);
ALTER TABLE leads
  ADD CONSTRAINT chk_desktop_critical_issues_positive
  CHECK (desktop_critical_issues >= 0);
ALTER TABLE leads
  ADD CONSTRAINT chk_seo_score_range
  CHECK (seo_score >= 0 AND seo_score <= 100);
ALTER TABLE leads
  ADD CONSTRAINT chk_content_score_range
  CHECK (content_score >= 0 AND content_score <= 100);
ALTER TABLE leads
  ADD CONSTRAINT chk_social_score_range
  CHECK (social_score >= 0 AND social_score <= 100);
ALTER TABLE leads
  ADD CONSTRAINT chk_analysis_cost_positive
  CHECK (analysis_cost IS NULL OR analysis_cost >= 0);
ALTER TABLE leads
  ADD CONSTRAINT chk_page_load_time_positive
  CHECK (page_load_time IS NULL OR page_load_time >= 0);
ALTER TABLE leads
  ADD CONSTRAINT chk_analysis_time_positive
  CHECK (analysis_time IS NULL OR analysis_time >= 0);
ALTER TABLE leads
  ADD CONSTRAINT chk_lead_priority_range
  CHECK (lead_priority IS NULL OR (lead_priority >= 0 AND lead_priority <= 100));
ALTER TABLE leads
  ADD CONSTRAINT chk_fit_score_range
  CHECK (fit_score IS NULL OR (fit_score >= 0 AND fit_score <= 100));

-- Check constraints for reports
ALTER TABLE reports
  ADD CONSTRAINT chk_reports_format
  CHECK (format IN ('markdown', 'pdf', 'html', 'json'));
ALTER TABLE reports
  ADD CONSTRAINT chk_reports_status
  CHECK (status IN ('generating', 'completed', 'failed'));
ALTER TABLE reports
  ADD CONSTRAINT chk_reports_file_size_positive
  CHECK (file_size_bytes IS NULL OR file_size_bytes >= 0);
ALTER TABLE reports
  ADD CONSTRAINT chk_reports_download_count_positive
  CHECK (download_count >= 0);

-- Check constraints for project_prospects
ALTER TABLE project_prospects
  ADD CONSTRAINT chk_custom_score_range
  CHECK (custom_score IS NULL OR (custom_score >= 0 AND custom_score <= 100));
ALTER TABLE project_prospects
  ADD CONSTRAINT chk_discovery_cost_positive
  CHECK (discovery_cost_usd IS NULL OR discovery_cost_usd >= 0);
ALTER TABLE project_prospects
  ADD CONSTRAINT chk_discovery_time_positive
  CHECK (discovery_time_ms IS NULL OR discovery_time_ms >= 0);

-- Check constraints for composed_emails
ALTER TABLE composed_emails
  ADD CONSTRAINT chk_quality_score_range
  CHECK (quality_score IS NULL OR (quality_score >= 0 AND quality_score <= 100));
ALTER TABLE composed_emails
  ADD CONSTRAINT chk_generation_cost_positive
  CHECK (generation_cost IS NULL OR generation_cost >= 0);
ALTER TABLE composed_emails
  ADD CONSTRAINT chk_character_count_positive
  CHECK (character_count IS NULL OR character_count >= 0);
ALTER TABLE composed_emails
  ADD CONSTRAINT chk_generation_time_positive
  CHECK (generation_time_ms IS NULL OR generation_time_ms >= 0);
ALTER TABLE composed_emails
  ADD CONSTRAINT chk_tokens_positive
  CHECK (usage_input_tokens IS NULL OR usage_input_tokens >= 0);
ALTER TABLE composed_emails
  ADD CONSTRAINT chk_output_tokens_positive
  CHECK (usage_output_tokens IS NULL OR usage_output_tokens >= 0);

-- Check constraints for campaigns
ALTER TABLE campaigns
  ADD CONSTRAINT chk_total_runs_positive
  CHECK (total_runs >= 0);
ALTER TABLE campaigns
  ADD CONSTRAINT chk_total_cost_positive
  CHECK (total_cost >= 0);
ALTER TABLE campaigns
  ADD CONSTRAINT chk_run_times_order
  CHECK (next_run_at IS NULL OR last_run_at IS NULL OR next_run_at >= last_run_at);

-- Check constraints for campaign_runs
ALTER TABLE campaign_runs
  ADD CONSTRAINT chk_steps_completed_positive
  CHECK (steps_completed >= 0);
ALTER TABLE campaign_runs
  ADD CONSTRAINT chk_steps_failed_positive
  CHECK (steps_failed >= 0);
ALTER TABLE campaign_runs
  ADD CONSTRAINT chk_total_cost_positive
  CHECK (total_cost >= 0);
ALTER TABLE campaign_runs
  ADD CONSTRAINT chk_run_times_order
  CHECK (completed_at IS NULL OR completed_at >= started_at);

-- CREATE UNIQUE CONSTRAINTS
-- Unique constraints for project_prospects
ALTER TABLE project_prospects
  ADD CONSTRAINT uq_project_prospect
  UNIQUE (project_id, prospect_id);


âœ… âœ… Dry run complete - no changes made to database
